<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LSystems</title>
    <script src="core/generator.js"></script>
    <script src="core/curve_storage.js"></script>
    <script src="display/turtle.js"></script>
    <script src="display/three_js.js"></script>
    <script src="widgets/curve_chooser.js"></script>
    <script src="widgets/curve_interface.js"></script>
    <link rel="stylesheet" href="style.css">

</head>
<body>

    <div id="wrap">
        <div id="controls">
            <div id="chooser">
                <label>
                    <select id="chooser_select"></select>
                    <input id="chooser_button" type="button" value="Load">
                </label>
            </div>

            <hr />
            <fieldset>
                <legend>Grammar</legend>
                <label>
                    Axiom: <input id="axiom" type="text">
                </label>

                <div class="inline">
                    <label>
                        Angle: <input id="angle" class="small" type="number">
                    </label>
                    <label>
                        Depth: <input id="depth" class="small" type="number">
                    </label>
                    <label>
                        Step: <input id="step" class="small" type="number">
                    </label>
                </div>

                <label>
                    Rules: <textarea id="rules"></textarea>
                </label>
            </fieldset>
            <fieldset>
                <legend>Operations</legend>
                <label>
                    ForwardXY: <input id="forwardXY" type="text">
                </label>
                <div class="inline">
                    <label>
                        XY+: <input class="small" id="turnXYcw" type="text">
                    </label>
                    <label>
                        XY-: <input class="small" id="turnXYccw" type="text">
                    </label>
                </div>
            </fieldset>

            <input id="render" type="button" value="Render">
            <label class="display_inline">
                <input id="clear" type="checkbox" checked="checked" /> Clear
            </label>


        </div>

        <div id="container">
            <div id="log"></div>
        </div>
    </div>
    <script type="importmap">
			{
				"imports": {
					"three": "/bin/threejs/three.module.js"
				}
			}
    </script>

    <script type="module">

        ///////////////////////////
        //Core Setup
        ///////////////////////////
        import * as THREE from 'three';
        import { OrbitControls } from '/bin/threejs/controls/OrbitControls.js';

        const container = document.getElementById("container")
        const display = new ThreeJsDisplay(THREE, OrbitControls, container)
        container.prepend(display.renderer.domElement);


        function animate() {
            requestAnimationFrame( animate );
            display.update()
        }
        animate()

        //////////////////////////////
        //Curve Interface
        //////////////////////////////
        const curve_interface = new CurveInterface(
            document.getElementById("axiom"), document.getElementById('rules'),
            document.getElementById('angle'), document.getElementById('depth'), document.getElementById('step'),
            document.getElementById("forwardXY"), document.getElementById("turnXYcw"), document.getElementById('turnXYccw')
        )

        ///////////////////////////
        //Core / UI interface
        ///////////////////////////
        var render_curve = function(curve_info){
            const gen = new Generator(curve_info.rules, curve_info.axiom, curve_info.depth)
            while(gen.hasNext()){
                let symbol = gen.step()

                if(curve_info.forwardXY.includes(symbol)){
                    display.forwardXY(curve_info.step);
                } else if(curve_info.turnXYcw.includes(symbol)){
                    display.turnXY(-curve_info.angle);
                } else if(curve_info.turnXYccw.includes(symbol)){
                    display.turnXY(curve_info.angle);
                }
            }
        }

        ///////////////////////////
        //Curve Storage and Choice
        ///////////////////////////
        var curve_storage = new CurveStorage()
        curve_storage.addCurve('koch', "Koch", {"F":"F+F-F-F+F"}, "F", 2, 90, 5, "F","-","+")


        var chooser_select = document.getElementById("chooser_select")
        var chooser_button = document.getElementById("chooser_button")
        curve_chooser(curve_storage, chooser_select)
        chooser_button.onclick = (function(){

            const curve_info = curve_storage.getCurve(chooser_select.value)
            if(curve_info){
                curve_interface.populate(curve_info)
            }
        })

        const clear = document.getElementById("clear")
        document.getElementById("render").onclick = function(){
            const curve_info = curve_interface.getInfo();
            console.log(clear.checked);
            render_curve(curve_info);
        };


    </script>
</body>
</html>